unit Unit1;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.Menus, Vcl.StdCtrls, Vcl.ExtCtrls,
  System.ImageList, Vcl.ImgList, libwebp, WebpHelpers, Winapi.GDIPAPI, Winapi.GDIPOBJ, Math, Vcl.WebpImage, IOUtils,
  Vcl.ComCtrls;

type
  TMainForm = class(TForm)
    ListBox1: TListBox;
    Panel2: TPanel;
    Panel3: TPanel;
    ListBox2: TListBox;
    Panel1: TPanel;
    bAdd: TButton;
    bAddAll: TButton;
    bRemove: TButton;
    bClear: TButton;
    MainMenu1: TMainMenu;
    File1: TMenuItem;
    Exit1: TMenuItem;
    About1: TMenuItem;
    Button5: TButton;
    ImageList1: TImageList;
    ProgressBar1: TProgressBar;
    Button6: TButton;
    cbSettings: TComboBox;
    procedure Exit1Click(Sender: TObject);
    procedure About1Click(Sender: TObject);
    procedure Button5Click(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure bAddClick(Sender: TObject);
    procedure bClearClick(Sender: TObject);
    procedure bRemoveClick(Sender: TObject);
    procedure bAddAllClick(Sender: TObject);
    procedure Button6Click(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  MainForm: TMainForm;

implementation

{$R *.dfm}

uses Unit2, Unit3;

procedure TMainForm.About1Click(Sender: TObject);
begin
  AboutForm.ShowModal;
end;

procedure TMainForm.bAddClick(Sender: TObject);
var
  str: string;
  i: Integer;
begin
  str := ListBox1.Items[ListBox1.ItemIndex];
  for i:= 0 to ListBox2.Items.Count - 1 do begin
    if str = ListBox2.Items[i] then begin
      Exit;
    end;
  end;
  ListBox2.Items.Add(str);
end;

procedure TMainForm.bAddAllClick(Sender: TObject);
var
  str: string;
  i: Integer;
begin
  ListBox2.Items.Clear;
  for i:= 0 to ListBox1.Items.Count - 1 do begin
    str := ListBox1.Items[i];
    ListBox2.Items.Add(str);
  end;
end;

procedure TMainForm.bRemoveClick(Sender: TObject);
begin
  ListBox2.Items.Delete(ListBox2.ItemIndex);
end;

procedure TMainForm.bClearClick(Sender: TObject);
begin
  ListBox2.Items.Clear;
end;

procedure TMainForm.Button5Click(Sender: TObject);
var
  stream: TMemoryStream;
  fs : TFileStream;
  bmp : TGPBitmap;
  dat : PByte;
  str: string;
  i: Integer;
begin
  if ListBox2.Items.Count < 0 then begin
    Exit;
  end;
  Button5.Enabled := False;
  ProgressBar1.Position := 0;
  ProgressBar1.Max := ListBox2.Items.Count;
  for i:= 0 to ListBox2.Items.Count - 1 do begin
    Application.ProcessMessages();
    str := ListBox2.Items[i];
    if cbSettings.Text = 'webp' then begin
      stream := TMemoryStream.Create;
      bmp := TGPBitmap.Create(str);
      WebpEncode(stream, bmp, SettingForm.tbWebpQuality.Position);
      stream.SaveToFile('out\'+ IntToStr(i) +'.webp');
      bmp.Free;
      stream.Free;
    end;
    if cbSettings.Text = 'jpeg' then begin
      fs := TFileStream.Create(str, fmOpenRead);
      WebpDecode(fs, dat, bmp);
      bmp.Save('out\'+ IntToStr(i) +'.jpeg', gPJG);
      bmp.Free;
      fs.Free;
      WebPFree(dat);
    end;
    ProgressBar1.Position := i + 1;
  end;
  Button5.Enabled := True;
end;

procedure TMainForm.Button6Click(Sender: TObject);
begin
  SettingForm.ShowModal;
end;

procedure TMainForm.Exit1Click(Sender: TObject);
begin
  MainForm.Close;
end;

procedure LoadFileList(aFiles: TStrings; sPath: string; sMask: string = '*.*');
var
  aFile: string;
begin
  aFiles.Clear;
  for aFile in TDirectory.GetFiles(IncludeTrailingPathDelimiter(sPath), sMask) do
    aFiles.Add(aFile)
end;

procedure TMainForm.FormCreate(Sender: TObject);
begin
  LoadFileList(ListBox1.Items, 'in');
end;

end.
